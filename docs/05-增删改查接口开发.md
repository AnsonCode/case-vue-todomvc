# 接口设计

```ts
// 「实时]获取全部待做事项
export async function getAllTodos(callback: (data: TodoItem[]) => void) {
  const resp = await fetch(`${baseUrl}/operations/GetAllTodos?wg_live=true`);
  if (resp.ok) {
    const reader = resp.body?.pipeThrough(new TextDecoderStream()).getReader();
    while (true) {
      const read = await reader?.read();
      try {
        if (read?.done) {
          break;
        }
        if (read?.value) {
          const json = JSON.parse(read.value);
          callback(json.data.data as TodoItem[]);
        }
      } catch (error) {
        //
      }
    }
  }
}
// 完成单个待做事项
export async function completedTodo(id: ID, completed: boolean) {
  const { error } = await request("CompleteTodo", {
    id,
    completed,
    method: "post",
  });
  return !error;
}
// 完成所有待做事项
export async function completedAllTodos(completed: boolean) {
  const { error } = await request("CompleteAllTodos", {
    completed,
    method: "post",
  });
  return !error;
}
// 创建待做事项
export async function createTodo(title: string) {
  const { error, data } = await request("CreateTodo", {
    method: "post",
    title,
  });
  return error ? false : data;
}
// 更新待做事项
export async function updateTitle(id: string, title: string) {
  const { error } = await request("UpdateTodoTitle", {
    method: "post",
    id,
    title,
  });
  return !error;
}
// 删除待做事项
export async function removeTodo(id: string) {
  const { error } = await request("RemoveTodo", { method: "post", id });
  return !error;
}
// 删除已完成的待做事项
export async function removeCompleted() {
  const { error } = await request("RemoveCompleted", { method: "post" });
  return !error;
}
```

# 接口开发

## 查询全部待做事项

```gql
query MyQuery {
  data: todo_findManyTodo {
    completed
    id
    title
  }
}
```

## 分页查询待做事项

复杂对象入参，如何动态传入

响应转换 指令，详情见[文档](https://ansons-organization.gitbook.io/product-manual/kai-fa-wen-dang/api-gou-jian/api-zhi-ling#xiang-ying-zhuan-huan)。

## 创建待做事项

```gql
mutation MyQuery($id: String! @injectGeneratedUUID, $title: String!) {
  data: todo_createOneTodo(data: { id: $id, title: $title, completed: false }) {
    id
    completed
    title
  }
}
```

- `@injectGeneratedUUID` 指令注入，生成 uuid。
- `createdAt`字段自动用当前日期

## 更新待做事项

### 完成待做事项

```gql
mutation MyQuery($completed: Boolean = false, $id: String = "") {
  data: todo_updateOneTodo(
    data: { completed: { set: $completed } }
    where: { id: $id }
  ) {
    id
  }
}
```

### 更新待做事项标题

```gql
mutation MyQuery($id: String!, $title: String!) {
  todo_updateOneTodo(data: { title: { set: $title } }, where: { id: $id }) {
    id
  }
}
```

### 通用更新

feature：不填写的字段不更新

将上述两个接口合成一个。

### 批量更新

```gql
mutation MyQuery($completed: Boolean!) {
  data: todo_updateManyTodo(data: { completed: { set: $completed } }) {
    count
  }
}
```

## 删除待做事项

### 单条删除

```gql
mutation MyQuery($id: String!) {
  todo_deleteOneTodo(where: { id: $id }) {
    id
  }
}
```

### 批量删除

```gql
mutation MyQuery {
  data: todo_deleteManyTodo(where: { completed: { equals: true } }) {
    count
  }
}
```

所有接口构建完毕，前往预览页可查看所有接口列表。

# 接口改造

## 实时查询

开启 `查询全部待做事项 `的实时配置功能，设置 1 秒更新 1 次。

`实时查询`原理见[文档](https://ansons-organization.gitbook.io/product-manual/kuai-su-ru-men/gong-zuo-yuan-li#fu-wu-duan-lun-xun)。

前端对接代码示例：

```ts
// 「实时]获取全部待做事项
export async function getAllTodos(callback: (data: TodoItem[]) => void) {
  const resp = await fetch(`${baseUrl}/operations/GetAllTodos?wg_live=true`);
  if (resp.ok) {
    // 这里是核心，实时读取流
    const reader = resp.body?.pipeThrough(new TextDecoderStream()).getReader();
    while (true) {
      const read = await reader?.read();
      try {
        if (read?.done) {
          break;
        }
        if (read?.value) {
          const json = JSON.parse(read.value);
          callback(json.data.data as TodoItem[]);
        }
      } catch (error) {
        //
      }
    }
  }
}
```

## 入参校验

```gql
mutation MyQuery($id: String! @injectGeneratedUUID, $title: String!) {
  data: todo_createOneTodo(data: { id: $id, title: $title, completed: false }) {
    id
    completed
    title
  }
}
```

`@` 指令注解，用正则表达式，校验`$title`入参。
